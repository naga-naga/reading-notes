# 第1章 ジェイウォーク（信号無視）
- 多対多を表現する際に、カンマ区切りの文字列などでデータを保持してしまうアンチパターン
- 問題
  - 正規表現で値を取り出すなどの操作が必要になり、クエリを作るのが面倒になる
  - インデックスを使えずパフォーマンスが落ちる
  - 集約クエリが上手く使えない
  - 値の更新時にソート順を維持できない
  - 値の妥当性の検証ができない
    - 全部文字列で入れることになるため
  - 区切り文字をどうするのか
  - リストの長さの制限をどう決めるのか
- 解決策
  - 多対多のテーブルを繋ぐ中間テーブルを作成する
  - 上記問題が解決するほか、各エントリに属性を追加できる

# 第2章 ナイーブツリー
- ツリー構造をデータベース上で扱う場合の話
- アンチパターン
  - `parent_id` のようなカラムを持ち、親のみに依存する方法
  - 隣接リストというらしい
- 問題点
  - 単純なクエリでは2つの階層しか見ることができない
    - 「あるノードの全ての子孫を取得する」といったクエリが書けない
      - 階層の分だけ `JOIN` が必要になる
    - かといって階層の数を制限するのも苦しい
      - ツリーにするということは、大抵の場合において深さに制限はないはず
  - ノードの削除が大変
    - リーフノード以外を削除した場合に、 `parent_id` の更新が必要になる
- アンチパターンを使ってもよい場合
  - 直近の親子のみを参照し、削除も行わないような場合
  - 再帰クエリ構文がサポートされている場合
- 解決策
  - 経路列挙(Path Enumeration, Materialized Path)
    - `'1/2/3/4/` のような形で、親子関係をパスの形にする
    - 先祖や子孫の参照が容易
    - パスの文字列の上限の問題がある
      - 第1章のジェイウォークと同じ問題
  - 入れ子集合(Nested Set)
    - ツリーを深さ優先探索して、ノードの左と右にそれぞれ番号を振っていく
    - 削除が容易
    - 直近の親の取得が大変
    - ノードの挿入や移動などの操作も面倒
      - ノードの左右の数値を毎回計算する必要がある
  - 閉包テーブル(Closure Table)
    - ツリー全体の先祖・子孫の関係を保持するテーブルを作る
    - 先祖や子孫の取得が容易
    - 削除も容易
      - ただし、閉包テーブルから消しても、本体は消されないことに注意
      - 関係性を柔軟に変更できる
    - 行数が多く、スペースを消費するというトレードオフ

# 第3章 ID Required
- 主キーとしてどのテーブルにも `AUTO INCREMENT` な `INTEGER` の `id` 列を作るアンチパターン
- 問題
  - 冗長なキーが作成されてしまう
    - 自然キー（ナチュラルキー）として使える列があるのに、わざわざ `id` 列を作るのは無駄
  - 重複行を許可してしまう
    - 交差テーブルにおいて `id` 列を主キーとすると、交差テーブルで繋ぐ二つのテーブルのそれぞれの主キー列のペアの重複を許してしまう
    - 主キー列のペアに `UNIQUE` 制約を付ける必要があるが、そうすると `id` 列は不要では？ という話
  - キーの意味が分かりづらくなる
    - `bug_id` や `account_id` などのような名前の方が分かりやすい
  - SQL の `USING` が使えない
    - `JOIN` で結合する際のカラム名が同じ場合、`USING` が使える
    - `id` 列を使うと `USING` で `JOIN` できない
- アンチパターンを使ってもよい場合
  - フレームワークで規定されている場合
    - Rails などまさにそう
  - 自然キーが長すぎる場合
- 解決策
  - 分かりやすい名前を付ける
    - 例えば `Bugs` テーブルの主キーは `bug_id`
  - 規約に縛られない
    - 必ずしもフレームワークに従う必要はない
      - 従った方が楽な気もしている
    - 新規のプロジェクトでこそ列名の明示的な指定が重要らしい
  - 自然キーや複合キーの活用
    - `NOT NULL` かつ `UNIQUE` な列があるのなら、疑似キーは不要
      - 自然キーとして使えそうな列が重複を許すようになってしまった場合は、疑似キーを作成するしかない
      - そういうことも織り込んで、初めから疑似キーを使うのが楽なのでは？ と思う
    - 交差テーブルでは複合キーを使った方が良さそう
